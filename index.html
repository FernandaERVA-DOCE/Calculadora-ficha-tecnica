<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Ficha Técnica</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; max-width: 980px; }
    h1 { margin: 0 0 8px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    label { display:block; font-size: 12px; color:#333; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 10px; border:1px solid #ccc; border-radius: 10px; }
    textarea { min-height: 86px; }
    .col { flex: 1; min-width: 220px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor:pointer; }
    .btn { background:#111; color:#fff; }
    .btn2 { background:#f1f1f1; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align:left; font-size: 14px; }
    .muted { color:#666; font-size: 12px; }
    .kpi { font-size: 18px; font-weight: bold; }
    .right { text-align:right; }
    .danger { color:#b00020; }
  </style>

  <!-- jsPDF (gera PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Calculadora de Ficha Técnica</h1>
  <div class="muted">MVP (salva no navegador + exporta PDF). Depois a gente evolui pra “produto” com login e nuvem.</div>

  <div class="card">
    <h3>Dados da receita</h3>
    <div class="row">
      <div class="col">
        <label>Nome da receita</label>
        <input id="nomeReceita" placeholder="Ex.: Sorvete probiótico (Cremaê)" />
      </div>
      <div class="col">
        <label>Rendimento (porções)</label>
        <input id="rendimento" type="number" min="1" value="10" />
      </div>
      <div class="col">
        <label>Margem desejada (%)</label>
        <input id="margem" type="number" min="0" value="60" />
      </div>
    </div>
    <div style="margin-top:10px;">
      <label>Modo de preparo (vai pro PDF)</label>
      <textarea id="modoPreparo" placeholder="Escreva o passo a passo..."></textarea>
    </div>
  </div>

  <div class="card">
    <h3>Adicionar ingrediente na receita</h3>
    <div class="row">
      <div class="col">
        <label>Ingrediente</label>
        <input id="ingNome" placeholder="Ex.: Leite de kefir" />
      </div>
      <div class="col">
        <label>Unidade (g / ml / un)</label>
        <select id="ingUn">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="un">un</option>
        </select>
      </div>
      <div class="col">
        <label>Quantidade</label>
        <input id="ingQtd" type="number" min="0" step="0.01" placeholder="Ex.: 600" />
      </div>
      <div class="col">
        <label>Preço por kg/L/un (R$)</label>
        <input id="ingPrecoBase" type="number" min="0" step="0.01" placeholder="Ex.: 25.00" />
        <div class="muted">Se unidade for g/ml, o preço aqui é por kg/L. Se for un, é por unidade.</div>
      </div>
    </div>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="addBtn">Adicionar</button>
      <button class="btn2" id="saveBtn">Salvar receita</button>
      <button class="btn2" id="loadBtn">Carregar última salva</button>
      <button class="btn2" id="clearBtn">Limpar tudo</button>
      <button class="btn" id="pdfBtn">Baixar PDF</button>
    </div>
    <div id="msg" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>Ingredientes</h3>
    <table>
      <thead>
        <tr>
          <th>Ingrediente</th>
          <th>Un</th>
          <th class="right">Qtd</th>
          <th class="right">Preço base</th>
          <th class="right">Custo</th>
          <th class="right">Ações</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div style="margin-top:12px;" class="row">
      <div class="col card" style="margin:0;">
        <div class="muted">Custo total</div>
        <div class="kpi" id="custoTotal">R$ 0,00</div>
      </div>
      <div class="col card" style="margin:0;">
        <div class="muted">Custo por porção</div>
        <div class="kpi" id="custoPorcao">R$ 0,00</div>
      </div>
      <div class="col card" style="margin:0;">
        <div class="muted">Preço sugerido (com margem)</div>
        <div class="kpi" id="precoSugerido">R$ 0,00</div>
      </div>
    </div>
    <div class="muted" style="margin-top:8px;">
      Fórmula preço sugerido: <b>preço = custo / (1 - margem%)</b>. Ex.: margem 60% ⇒ divide por 0,40.
    </div>
  </div>

<script>
  const state = {
    itens: []
  };

  const $ = (id) => document.getElementById(id);

  function money(n) {
    return (n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function calcItemCost(item) {
    const qtd = Number(item.qtd) || 0;
    const precoBase = Number(item.precoBase) || 0;

    // Se unidade for g ou ml: precoBase é por kg/L ⇒ custo = qtd * (precoBase/1000)
    // Se for un: precoBase é por unidade ⇒ custo = qtd * precoBase
    if (item.un === 'g' || item.un === 'ml') return qtd * (precoBase / 1000);
    return qtd * precoBase;
  }

  function render() {
    const tbody = $('tbody');
    tbody.innerHTML = '';

    let total = 0;
    state.itens.forEach((it, idx) => {
      const c = calcItemCost(it);
      total += c;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.nome}</td>
        <td>${it.un}</td>
        <td class="right">${Number(it.qtd || 0).toLocaleString('pt-BR')}</td>
        <td class="right">${money(it.precoBase)}</td>
        <td class="right"><b>${money(c)}</b></td>
        <td class="right">
          <button class="btn2" onclick="removeItem(${idx})">Remover</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    const rendimento = Math.max(1, Number($('rendimento').value) || 1);
    const custoPorcao = total / rendimento;

    const margem = Math.max(0, Math.min(99, Number($('margem').value) || 0));
    const fator = 1 - (margem / 100);
    const precoSug = fator > 0 ? (total / fator) : 0;
    const precoPorcao = precoSug / rendimento;

    $('custoTotal').textContent = money(total);
    $('custoPorcao').textContent = money(custoPorcao) + ` (≈ ${money(custoPorcao)} / porção)`;
    $('precoSugerido').textContent = money(precoSug) + ` (≈ ${money(precoPorcao)} / porção)`;
  }

  window.removeItem = function(idx) {
    state.itens.splice(idx, 1);
    render();
  }

  function msg(t, isErr=false) {
    $('msg').innerHTML = isErr ? `<span class="danger">${t}</span>` : t;
  }

  $('addBtn').addEventListener('click', () => {
    const nome = $('ingNome').value.trim();
    const un = $('ingUn').value;
    const qtd = Number($('ingQtd').value);
    const precoBase = Number($('ingPrecoBase').value);

    if (!nome) return msg('Coloque o nome do ingrediente.', true);
    if (!qtd || qtd <= 0) return msg('Quantidade precisa ser maior que 0.', true);
    if (!precoBase || precoBase <= 0) return msg('Preço base precisa ser maior que 0.', true);

    state.itens.push({ nome, un, qtd, precoBase });
    $('ingNome').value = '';
    $('ingQtd').value = '';
    $('ingPrecoBase').value = '';
    msg('Ingrediente adicionado ✅');
    render();
  });

  $('saveBtn').addEventListener('click', () => {
    const payload = {
      nomeReceita: $('nomeReceita').value,
      rendimento: $('rendimento').value,
      margem: $('margem').value,
      modoPreparo: $('modoPreparo').value,
      itens: state.itens
    };
    localStorage.setItem('ficha_mvp_ultima', JSON.stringify(payload));
    msg('Salvo no navegador ✅');
  });

  $('loadBtn').addEventListener('click', () => {
    const raw = localStorage.getItem('ficha_mvp_ultima');
    if (!raw) return msg('Nada salvo ainda.', true);
    const payload = JSON.parse(raw);
    $('nomeReceita').value = payload.nomeReceita || '';
    $('rendimento').value = payload.rendimento || 1;
    $('margem').value = payload.margem || 0;
    $('modoPreparo').value = payload.modoPreparo || '';
    state.itens = payload.itens || [];
    msg('Carregado ✅');
    render();
  });

  $('clearBtn').addEventListener('click', () => {
    state.itens = [];
    $('nomeReceita').value = '';
    $('modoPreparo').value = '';
    $('rendimento').value = 10;
    $('margem').value = 60;
    msg('Limpo ✅');
    render();
  });

  $('pdfBtn').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const nome = ($('nomeReceita').value || 'Ficha_Tecnica').trim();
    const rendimento = Math.max(1, Number($('rendimento').value) || 1);
    const margem = Math.max(0, Math.min(99, Number($('margem').value) || 0));
    const modo = $('modoPreparo').value || '';

    // Cálculos
    let total = 0;
    const linhas = state.itens.map(it => {
      const c = calcItemCost(it);
      total += c;
      return [it.nome, it.un, String(it.qtd), money(it.precoBase), money(c)];
    });

    const custoPorcao = total / rendimento;
    const fator = 1 - (margem / 100);
    const precoSug = fator > 0 ? (total / fator) : 0;
    const precoPorcao = precoSug / rendimento;

    // Cabeçalho
    doc.setFontSize(16);
    doc.text(`Ficha Técnica - ${nome}`, 14, 16);

    doc.setFontSize(11);
    doc.text(`Rendimento: ${rendimento} porções`, 14, 24);
    doc.text(`Margem: ${margem}%`, 14, 30);

    doc.text(`Custo total: ${money(total)}`, 14, 38);
    doc.text(`Custo por porção: ${money(custoPorcao)}`, 14, 44);
    doc.text(`Preço sugerido: ${money(precoSug)} (≈ ${money(precoPorcao)}/porção)`, 14, 50);

    // Tabela simples (sem plugin)
    let y = 60;
    doc.setFontSize(12);
    doc.text('Ingredientes', 14, y);
    y += 6;

    doc.setFontSize(10);
    const headers = ['Ingrediente', 'Un', 'Qtd', 'Preço base', 'Custo'];
    doc.text(headers.join(' | '), 14, y);
    y += 6;

    linhas.forEach(row => {
      const line = row.join(' | ');
      if (y > 270) { doc.addPage(); y = 14; }
      doc.text(line, 14, y);
      y += 6;
    });

    y += 6;
    if (y > 260) { doc.addPage(); y = 14; }
    doc.setFontSize(12);
    doc.text('Modo de preparo', 14, y);
    y += 6;

    doc.setFontSize(10);
    const wrapped = doc.splitTextToSize(modo || '-', 180);
    wrapped.forEach(t => {
      if (y > 280) { doc.addPage(); y = 14; }
      doc.text(t, 14, y);
      y += 5;
    });

    doc.save(`${nome.replace(/[\\/:*?"<>|]/g, '-')}_ficha_tecnica.pdf`);
  });

  // Atualiza KPIs quando mexer em rendimento/margem
  $('rendimento').addEventListener('input', render);
  $('margem').addEventListener('input', render);

  render();
</script>
</body>
</html>