<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Ficha Técnica</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 18px; max-width: 980px; }
    h1 { margin: 0 0 8px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin: 12px 0; }
    label { display:block; font-size: 12px; color:#333; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 10px; border:1px solid #ccc; border-radius: 10px; }
    textarea { min-height: 86px; }
    .col { flex: 1; min-width: 220px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor:pointer; }
    .btn { background:#111; color:#fff; }
    .btn2 { background:#f1f1f1; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align:left; font-size: 14px; }
    .muted { color:#666; font-size: 12px; }
    .kpi { font-size: 18px; font-weight: bold; }
    .right { text-align:right; }
    .danger { color:#b00020; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    /* ===== MODO DE ATAQUE ===== */
    .modo-ataque { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
    .modo-ataque th {
      background-color: #2c3e50; color: #fff; padding: 10px; text-align: center;
      border-bottom: 1px solid #1f2b36; font-size: 13px; user-select: none;
    }
    .modo-ataque th.recipe-head { user-select: text; cursor: text; outline: none; }
    .modo-ataque td {
      border-bottom: 1px solid #eee; border-right: 1px solid #eee;
      padding: 10px; vertical-align: top; font-size: 13px;
      word-wrap: break-word; white-space: pre-wrap; /* cresce com enter */
    }
    .modo-ataque td:last-child { border-right: 0; }
    .modo-ataque tbody tr:nth-child(even) { background-color: #fafafa; }
    .modo-ataque td:first-child {
      font-weight: bold; text-align: center; background-color: #f3f3f3;
      width: 70px; user-select: none;
    }
    .editable { outline: none; min-height: 24px; }
    .editable:focus, .recipe-head:focus {
      outline: 2px solid #111; border-radius: 8px; background: #fff;
    }

    /* ====== IMPRESSÃO BONITA ====== */
    @media print {
      @page { size: A4; margin: 12mm; }
      body { margin: 0 !important; max-width: none !important; }
      h1 { margin: 0 0 6mm !important; }

      .no-print { display: none !important; }
      .card { border: 0 !important; padding: 0 !important; margin: 0 0 8mm !important; }
      .muted { color: #000 !important; }

      input, textarea, select {
        border: 0 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        outline: none !important;
        box-shadow: none !important;
        font-size: 12pt !important;
      }
      textarea { min-height: auto !important; }

      table { page-break-inside: auto; }
      tr, td, th { page-break-inside: avoid; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }

      .modo-ataque th, .modo-ataque td { border: 1px solid #000 !important; }
      .modo-ataque th { background: #eaeaea !important; color: #000 !important; }

      .kpi { font-size: 14pt !important; }
      .page-break { break-before: page; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <h1>Calculadora de Ficha Técnica</h1>
  <div class="muted no-print">MVP (salva no navegador + exporta PDF). Agora com impressão A4 bonitinha.</div>

  <div class="card">
    <h3>Dados da receita</h3>
    <div class="row">
      <div class="col">
        <label>Nome da receita</label>
        <input id="nomeReceita" placeholder="Ex.: Sorvete probiótico (Cremaê)" />
      </div>
      <div class="col">
        <label>Rendimento (porções)</label>
        <input id="rendimento" type="number" min="1" value="10" />
      </div>
      <div class="col">
        <label>Margem desejada (%)</label>
        <input id="margem" type="number" min="0" value="60" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Modo de preparo</label>
      <textarea id="modoPreparo" placeholder="Escreva o passo a passo..."></textarea>
    </div>
  </div>

  <div class="card">
    <h3>Modo de Ataque (ordem de execução por receita)</h3>
    <div class="muted no-print">
      Clique nos <b>títulos</b> para renomear. As células crescem conforme você escreve. Use os botões para mais etapas.
    </div>

    <div class="toolbar no-print">
      <button class="btn2" id="addEtapaBtn">Adicionar etapa</button>
      <button class="btn2" id="remEtapaBtn">Remover última etapa</button>
      <button class="btn2" id="clearAtaqueBtn">Limpar modo de ataque</button>
      <button class="btn" id="printBtn">Imprimir (A4)</button>
    </div>

    <div style="margin-top:10px; overflow:auto;">
      <table class="modo-ataque" id="modoAtaqueTable">
        <thead>
          <tr>
            <th>Etapa</th>
            <th class="recipe-head" contenteditable="true">Receita 1</th>
            <th class="recipe-head" contenteditable="true">Receita 2</th>
            <th class="recipe-head" contenteditable="true">Receita 3</th>
            <th class="recipe-head" contenteditable="true">Receita 4</th>
            <th class="recipe-head" contenteditable="true">Receita 5</th>
          </tr>
        </thead>
        <tbody id="modoAtaqueBody"></tbody>
      </table>
    </div>
  </div>

  <!-- FORMULÁRIO NÃO IMPRIME -->
  <div class="card no-print">
    <h3>Adicionar ingrediente na receita</h3>
    <div class="row">
      <div class="col">
        <label>Ingrediente</label>
        <input id="ingNome" placeholder="Ex.: Leite de kefir" />
      </div>
      <div class="col">
        <label>Unidade (g / ml / un)</label>
        <select id="ingUn">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="un">un</option>
        </select>
      </div>
      <div class="col">
        <label>Quantidade</label>
        <input id="ingQtd" type="number" min="0" step="0.01" placeholder="Ex.: 600" />
      </div>
      <div class="col">
        <label>Preço por kg/L/un (R$) (opcional)</label>
        <input id="ingPrecoBase" type="number" min="0" step="0.01" placeholder="Ex.: 25.00" />
        <div class="muted">Você pode deixar em branco. Se unidade for g/ml, o preço é por kg/L. Se for un, por unidade.</div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="addBtn">Adicionar</button>
      <button class="btn2" id="saveBtn">Salvar receita</button>
      <button class="btn2" id="loadBtn">Carregar última salva</button>
      <button class="btn2" id="clearBtn">Limpar tudo</button>
      <button class="btn" id="pdfBtn">Baixar PDF</button>
    </div>
    <div id="msg" class="muted" style="margin-top:10px;"></div>
  </div>

  <!-- ✅ ESTA PARTE IMPRIME -->
  <div class="card">
    <h3>Ingredientes</h3>
    <table>
      <thead>
        <tr>
          <th>Ingrediente</th>
          <th>Un</th>
          <th class="right">Qtd</th>
          <th class="right">Preço base</th>
          <th class="right">Custo</th>
          <th class="right no-print">Ações</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div style="margin-top:12px;" class="row">
      <div class="col card" style="margin:0;">
        <div class="muted">Custo total</div>
        <div class="kpi" id="custoTotal">R$ 0,00</div>
      </div>
      <div class="col card" style="margin:0;">
        <div class="muted">Custo por porção</div>
        <div class="kpi" id="custoPorcao">R$ 0,00</div>
      </div>
      <div class="col card" style="margin:0;">
        <div class="muted">Preço sugerido (com margem)</div>
        <div class="kpi" id="precoSugerido">R$ 0,00</div>
      </div>
    </div>
  </div>

<script>
  const state = { itens: [] };
  const $ = (id) => document.getElementById(id);

  function money(n) {
    return (n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  /* ✅ PREÇO OPCIONAL */
  function calcItemCost(item) {
    const qtd = Number(item.qtd) || 0;

    const raw = item.precoBase;
    const preco = (raw === '' || raw === null || raw === undefined) ? NaN : Number(raw);

    if (!isFinite(preco) || preco <= 0) return 0;

    if (item.un === 'g' || item.un === 'ml') return qtd * (preco / 1000);
    return qtd * preco;
  }

  function msg(t, isErr=false) {
    $('msg').innerHTML = isErr ? `<span class="danger">${t}</span>` : t;
  }

  // ===== MODO DE ATAQUE =====
  function readAtaqueHeaders() {
    const ths = document.querySelectorAll('#modoAtaqueTable thead th.recipe-head');
    return [...ths].map((th, i) => (th.innerText || '').trim() || `Receita ${i+1}`);
  }

  function applyAtaqueHeaders(headers) {
    const ths = document.querySelectorAll('#modoAtaqueTable thead th.recipe-head');
    const safe = Array.isArray(headers) ? headers : [];
    [...ths].forEach((th, i) => {
      th.innerText = (safe[i] && String(safe[i]).trim()) ? String(safe[i]).trim() : `Receita ${i+1}`;
    });
  }

  function buildRow(etapaNum, receitas) {
    const r = Array.isArray(receitas) ? receitas : ['', '', '', '', ''];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${etapaNum}</td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
    `;
    const cells = tr.querySelectorAll('td.editable');
    cells.forEach((c, idx) => c.innerText = r[idx] || '');
    return tr;
  }

  function renumerarEtapas() {
    const rows = $('modoAtaqueBody').querySelectorAll('tr');
    rows.forEach((tr, i) => tr.querySelector('td').innerText = String(i + 1));
  }

  function addNovaEtapa(receitas=['','','','','']) {
    const body = $('modoAtaqueBody');
    const etapaNum = body.querySelectorAll('tr').length + 1;
    body.appendChild(buildRow(etapaNum, receitas));
  }

  function readModoAtaque() {
    const rows = [...$('modoAtaqueBody').querySelectorAll('tr')];
    return rows.map(r => {
      const cells = [...r.querySelectorAll('td')];
      return { etapa: cells[0].innerText.trim(), receitas: cells.slice(1).map(c => c.innerText) };
    });
  }

  function applyModoAtaque(data, minRows=5) {
    const body = $('modoAtaqueBody');
    body.innerHTML = '';
    const safe = Array.isArray(data) ? data : [];
    const count = Math.max(minRows, safe.length || 0);
    for (let i = 0; i < count; i++) {
      const receitas = safe[i]?.receitas || ['', '', '', '', ''];
      body.appendChild(buildRow(i + 1, receitas));
    }
  }

  // ===== Render ingredientes =====
  function render() {
    const tbody = $('tbody');
    tbody.innerHTML = '';

    let total = 0;
    state.itens.forEach((it, idx) => {
      const c = calcItemCost(it);
      total += c;

      const precoMostra = (it.precoBase === '' || it.precoBase === null || it.precoBase === undefined)
        ? '—'
        : money(Number(it.precoBase));

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.nome}</td>
        <td>${it.un}</td>
        <td class="right">${Number(it.qtd || 0).toLocaleString('pt-BR')}</td>
        <td class="right">${precoMostra}</td>
        <td class="right"><b>${money(c)}</b></td>
        <td class="right no-print"><button class="btn2" onclick="removeItem(${idx})">Remover</button></td>
      `;
      tbody.appendChild(tr);
    });

    const rendimento = Math.max(1, Number($('rendimento').value) || 1);
    const custoPorcao = total / rendimento;

    const margem = Math.max(0, Math.min(99, Number($('margem').value) || 0));
    const fator = 1 - (margem / 100);
    const precoSug = fator > 0 ? (total / fator) : 0;
    const precoPorcao = precoSug / rendimento;

    $('custoTotal').textContent = money(total);
    $('custoPorcao').textContent = money(custoPorcao) + ` (≈ ${money(custoPorcao)} / porção)`;
    $('precoSugerido').textContent = money(precoSug) + ` (≈ ${money(precoPorcao)} / porção)`;
  }

  window.removeItem = function(idx) {
    state.itens.splice(idx, 1);
    render();
  };

  /* ✅ PREÇO NÃO OBRIGATÓRIO NO ADD */
  $('addBtn')?.addEventListener('click', () => {
    const nome = $('ingNome').value.trim();
    const un = $('ingUn').value;
    const qtd = Number($('ingQtd').value);

    const precoStr = $('ingPrecoBase').value.trim(); // pode ser ""

    if (!nome) return msg('Coloque o nome do ingrediente.', true);
    if (!qtd || qtd <= 0) return msg('Quantidade precisa ser maior que 0.', true);

    state.itens.push({ nome, un, qtd, precoBase: precoStr });

    $('ingNome').value = '';
    $('ingQtd').value = '';
    $('ingPrecoBase').value = '';
    msg(precoStr ? 'Ingrediente adicionado ✅' : 'Ingrediente adicionado (sem preço) ✅');
    render();
  });

  $('saveBtn')?.addEventListener('click', () => {
    const payload = {
      nomeReceita: $('nomeReceita').value,
      rendimento: $('rendimento').value,
      margem: $('margem').value,
      modoPreparo: $('modoPreparo').value,
      itens: state.itens,
      modoAtaqueHeaders: readAtaqueHeaders(),
      modoAtaque: readModoAtaque()
    };
    localStorage.setItem('ficha_mvp_ultima', JSON.stringify(payload));
    msg('Salvo no navegador ✅');
  });

  $('loadBtn')?.addEventListener('click', () => {
    const raw = localStorage.getItem('ficha_mvp_ultima');
    if (!raw) return msg('Nada salvo ainda.', true);
    const payload = JSON.parse(raw);

    $('nomeReceita').value = payload.nomeReceita || '';
    $('rendimento').value = payload.rendimento || 1;
    $('margem').value = payload.margem || 0;
    $('modoPreparo').value = payload.modoPreparo || '';
    state.itens = payload.itens || [];

    applyAtaqueHeaders(payload.modoAtaqueHeaders || []);
    applyModoAtaque(payload.modoAtaque || [], 5);

    msg('Carregado ✅');
    render();
  });

  $('clearBtn')?.addEventListener('click', () => {
    state.itens = [];
    $('nomeReceita').value = '';
    $('modoPreparo').value = '';
    $('rendimento').value = 10;
    $('margem').value = 60;

    applyAtaqueHeaders([]);
    applyModoAtaque([], 5);

    msg('Limpo ✅');
    render();
  });

  $('addEtapaBtn').addEventListener('click', () => addNovaEtapa());
  $('remEtapaBtn').addEventListener('click', () => {
    const body = $('modoAtaqueBody');
    const rows = body.querySelectorAll('tr');
    if (rows.length <= 1) return;
    body.removeChild(rows[rows.length - 1]);
    renumerarEtapas();
  });
  $('clearAtaqueBtn').addEventListener('click', () => {
    applyAtaqueHeaders([]);
    applyModoAtaque([], 5);
  });

  $('printBtn').addEventListener('click', () => window.print());

  // inicia com 5 linhas
  applyModoAtaque([], 5);
  render();
</script>
</body>
</html>
