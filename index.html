<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Ficha T√©cnica</title>

  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>

  <div class="header">
    <div>
      <h1>Calculadora de Ficha T√©cnica</h1>
      <div class="brand-sub no-print">üçΩÔ∏è Ficha + Modo de Ataque + impress√£o A4</div>
    </div>
    <div class="gastro-icons no-print" aria-hidden="true">
      <span>üç¥</span><span>ü•Ñ</span><span>üî™</span><span>ü•£</span><span>üßÅ</span>
    </div>
  </div>

  <!-- ‚úÖ DADOS DO ALUNO -->
  <div class="card">
    <h3>Identifica√ß√£o</h3>
    <div class="row">
      <div class="col">
        <label>Nome do aluno</label>
        <input id="nomeAluno" placeholder="Ex.: Fernanda Arantes" />
      </div>
      <div class="col">
        <label>RA (opcional)</label>
        <input id="raAluno" placeholder="Ex.: 12345678" />
      </div>
      <div class="col">
        <label>Turma / Disciplina (opcional)</label>
        <input id="turmaAluno" placeholder="Ex.: Gastronomia - Cozinha X" />
      </div>
    </div>
    <div class="muted">Esses dados aparecem na impress√£o.</div>
  </div>

  <div class="card">
    <h3>Dados da receita</h3>
    <div class="row">
      <div class="col">
        <label>Nome da receita</label>
        <input id="nomeReceita" placeholder="Ex.: Sorvete probi√≥tico (Crema√™)" />
      </div>
      <div class="col">
        <label>Rendimento (por√ß√µes)</label>
        <input id="rendimento" type="number" min="1" value="10" />
      </div>
      <div class="col">
        <label>Margem desejada (%)</label>
        <input id="margem" type="number" min="0" value="60" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Modo de preparo</label>
      <textarea id="modoPreparo" placeholder="Escreva o passo a passo..."></textarea>
    </div>
  </div>

  <div class="card">
    <h3>Modo de Ataque (ordem de execu√ß√£o por receita)</h3>
    <div class="muted no-print">
      Clique nos <b>t√≠tulos</b> para renomear. As c√©lulas crescem conforme voc√™ escreve. Use os bot√µes para mais etapas.
    </div>

    <div class="toolbar no-print">
      <button class="btn2" id="addEtapaBtn">Adicionar etapa</button>
      <button class="btn2" id="remEtapaBtn">Remover √∫ltima etapa</button>
      <button class="btn2" id="clearAtaqueBtn">Limpar modo de ataque</button>
      <button class="btn" id="printBtn">Imprimir (A4)</button>
    </div>

    <div style="margin-top:10px; overflow:auto;">
      <table class="modo-ataque" id="modoAtaqueTable">
        <thead>
          <tr>
            <th>Etapa</th>
            <th class="recipe-head" contenteditable="true">Receita 1</th>
            <th class="recipe-head" contenteditable="true">Receita 2</th>
            <th class="recipe-head" contenteditable="true">Receita 3</th>
            <th class="recipe-head" contenteditable="true">Receita 4</th>
            <th class="recipe-head" contenteditable="true">Receita 5</th>
          </tr>
        </thead>
        <tbody id="modoAtaqueBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card no-print">
    <h3>Adicionar ingrediente na receita</h3>
    <div class="row">
      <div class="col">
        <label>Ingrediente</label>
        <input id="ingNome" placeholder="Ex.: Leite de kefir" />
      </div>
      <div class="col">
        <label>Unidade (g / ml / un)</label>
        <select id="ingUn">
          <option value="g">g</option>
          <option value="ml">ml</option>
          <option value="un">un</option>
        </select>
      </div>
      <div class="col">
        <label>Quantidade</label>
        <input id="ingQtd" type="number" min="0" step="0.01" placeholder="Ex.: 600" />
      </div>
      <div class="col">
        <label>Pre√ßo por kg/L/un (R$) (opcional)</label>
        <input id="ingPrecoBase" type="number" min="0" step="0.01" placeholder="Ex.: 25.00" />
        <div class="muted">Voc√™ pode deixar em branco. Se unidade for g/ml, o pre√ßo √© por kg/L. Se for un, por unidade.</div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="addBtn">Adicionar</button>
      <button class="btn2" id="saveBtn">Salvar receita</button>
      <button class="btn2" id="loadBtn">Carregar √∫ltima salva</button>
      <button class="btn2" id="clearBtn">Limpar tudo</button>
      <button class="btn" id="pdfBtn">Baixar PDF</button>
    </div>
    <div id="msg" class="muted" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <h3>Ingredientes</h3>
    <table>
      <thead>
        <tr>
          <th>Ingrediente</th>
          <th>Un</th>
          <th class="right">Qtd</th>
          <th class="right">Pre√ßo base</th>
          <th class="right">Custo</th>
          <th class="right no-print">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div style="margin-top:12px;" class="row">
      <div class="col card kpi-box" style="margin:0;">
        <div class="muted">Custo total</div>
        <div class="kpi" id="custoTotal">R$ 0,00</div>
      </div>
      <div class="col card kpi-box" style="margin:0;">
        <div class="muted">Custo por por√ß√£o</div>
        <div class="kpi" id="custoPorcao">R$ 0,00</div>
      </div>
      <div class="col card kpi-box" style="margin:0;">
        <div class="muted">Pre√ßo sugerido (com margem)</div>
        <div class="kpi" id="precoSugerido">R$ 0,00</div>
      </div>
    </div>
  </div>

<script>
  const state = { itens: [] };
  const $ = (id) => document.getElementById(id);

  function money(n) {
    return (n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function calcItemCost(item) {
    const qtd = Number(item.qtd) || 0;
    const raw = item.precoBase;
    const preco = (raw === '' || raw === null || raw === undefined) ? NaN : Number(raw);
    if (!isFinite(preco) || preco <= 0) return 0;
    if (item.un === 'g' || item.un === 'ml') return qtd * (preco / 1000);
    return qtd * preco;
  }

  function msg(t, isErr=false) {
    $('msg').innerHTML = isErr ? `<span class="danger">${t}</span>` : t;
  }

  function readAtaqueHeaders() {
    const ths = document.querySelectorAll('#modoAtaqueTable thead th.recipe-head');
    return [...ths].map((th, i) => (th.innerText || '').trim() || `Receita ${i+1}`);
  }

  function applyAtaqueHeaders(headers) {
    const ths = document.querySelectorAll('#modoAtaqueTable thead th.recipe-head');
    const safe = Array.isArray(headers) ? headers : [];
    [...ths].forEach((th, i) => {
      th.innerText = (safe[i] && String(safe[i]).trim()) ? String(safe[i]).trim() : `Receita ${i+1}`;
    });
  }

  function buildRow(etapaNum, receitas) {
    const r = Array.isArray(receitas) ? receitas : ['', '', '', '', ''];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${etapaNum}</td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
      <td class="editable" contenteditable="true"></td>
    `;
    const cells = tr.querySelectorAll('td.editable');
    cells.forEach((c, idx) => c.innerText = r[idx] || '');
    return tr;
  }

  function renumerarEtapas() {
    const rows = $('modoAtaqueBody').querySelectorAll('tr');
    rows.forEach((tr, i) => tr.querySelector('td').innerText = String(i + 1));
  }

  function addNovaEtapa(receitas=['','','','','']) {
    const body = $('modoAtaqueBody');
    const etapaNum = body.querySelectorAll('tr').length + 1;
    body.appendChild(buildRow(etapaNum, receitas));
  }

  function readModoAtaque() {
    const rows = [...$('modoAtaqueBody').querySelectorAll('tr')];
    return rows.map(r => {
      const cells = [...r.querySelectorAll('td')];
      return { etapa: cells[0].innerText.trim(), receitas: cells.slice(1).map(c => c.innerText) };
    });
  }

  function applyModoAtaque(data, minRows=5) {
    const body = $('modoAtaqueBody');
    body.innerHTML = '';
    const safe = Array.isArray(data) ? data : [];
    const count = Math.max(minRows, safe.length || 0);
    for (let i = 0; i < count; i++) {
      const receitas = safe[i]?.receitas || ['', '', '', '', ''];
      body.appendChild(buildRow(i + 1, receitas));
    }
  }

  function render() {
    const tbody = $('tbody');
    tbody.innerHTML = '';

    let total = 0;
    state.itens.forEach((it, idx) => {
      const c = calcItemCost(it);
      total += c;

      const precoMostra = (it.precoBase === '' || it.precoBase === null || it.precoBase === undefined)
        ? '‚Äî'
        : money(Number(it.precoBase));

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.nome}</td>
        <td>${it.un}</td>
        <td class="right">${Number(it.qtd || 0).toLocaleString('pt-BR')}</td>
        <td class="right">${precoMostra}</td>
        <td class="right"><b>${money(c)}</b></td>
        <td class="right no-print"><button class="btn2" onclick="removeItem(${idx})">Remover</button></td>
      `;
      tbody.appendChild(tr);
    });

    const rendimento = Math.max(1, Number($('rendimento').value) || 1);
    const custoPorcao = total / rendimento;

    const margem = Math.max(0, Math.min(99, Number($('margem').value) || 0));
    const fator = 1 - (margem / 100);
    const precoSug = fator > 0 ? (total / fator) : 0;
    const precoPorcao = precoSug / rendimento;

    $('custoTotal').textContent = money(total);
    $('custoPorcao').textContent = money(custoPorcao) + ` (‚âà ${money(custoPorcao)} / por√ß√£o)`;
    $('precoSugerido').textContent = money(precoSug) + ` (‚âà ${money(precoPorcao)} / por√ß√£o)`;
  }

  window.removeItem = function(idx) {
    state.itens.splice(idx, 1);
    render();
  };

  $('addBtn')?.addEventListener('click', () => {
    const nome = $('ingNome').value.trim();
    const un = $('ingUn').value;
    const qtd = Number($('ingQtd').value);
    const precoStr = $('ingPrecoBase').value.trim();

    if (!nome) return msg('Coloque o nome do ingrediente.', true);
    if (!qtd || qtd <= 0) return msg('Quantidade precisa ser maior que 0.', true);

    state.itens.push({ nome, un, qtd, precoBase: precoStr });

    $('ingNome').value = '';
    $('ingQtd').value = '';
    $('ingPrecoBase').value = '';
    msg(precoStr ? 'Ingrediente adicionado ‚úÖ' : 'Ingrediente adicionado (sem pre√ßo) ‚úÖ');
    render();
  });

  $('saveBtn')?.addEventListener('click', () => {
    const payload = {
      nomeReceita: $('nomeReceita').value,
      rendimento: $('rendimento').value,
      margem: $('margem').value,
      modoPreparo: $('modoPreparo').value,
      itens: state.itens,
      modoAtaqueHeaders: readAtaqueHeaders(),
      modoAtaque: readModoAtaque()
      // (opcional no futuro: salvar nome do aluno tamb√©m)
    };
    localStorage.setItem('ficha_mvp_ultima', JSON.stringify(payload));
    msg('Salvo no navegador ‚úÖ');
  });

  $('loadBtn')?.addEventListener('click', () => {
    const raw = localStorage.getItem('ficha_mvp_ultima');
    if (!raw) return msg('Nada salvo ainda.', true);
    const payload = JSON.parse(raw);

    $('nomeReceita').value = payload.nomeReceita || '';
    $('rendimento').value = payload.rendimento || 1;
    $('margem').value = payload.margem || 0;
    $('modoPreparo').value = payload.modoPreparo || '';
    state.itens = payload.itens || [];

    applyAtaqueHeaders(payload.modoAtaqueHeaders || []);
    applyModoAtaque(payload.modoAtaque || [], 5);

    msg('Carregado ‚úÖ');
    render();
  });

  $('clearBtn')?.addEventListener('click', () => {
    state.itens = [];
    $('nomeReceita').value = '';
    $('modoPreparo').value = '';
    $('rendimento').value = 10;
    $('margem').value = 60;

    applyAtaqueHeaders([]);
    applyModoAtaque([], 5);

    msg('Limpo ‚úÖ');
    render();
  });

  $('addEtapaBtn').addEventListener('click', () => addNovaEtapa());
  $('remEtapaBtn').addEventListener('click', () => {
    const body = $('modoAtaqueBody');
    const rows = body.querySelectorAll('tr');
    if (rows.length <= 1) return;
    body.removeChild(rows[rows.length - 1]);
    renumerarEtapas();
  });
  $('clearAtaqueBtn').addEventListener('click', () => {
    applyAtaqueHeaders([]);
    applyModoAtaque([], 5);
  });

  $('printBtn').addEventListener('click', () => window.print());

  applyModoAtaque([], 5);
  render();
</script>
</body>
</html>
